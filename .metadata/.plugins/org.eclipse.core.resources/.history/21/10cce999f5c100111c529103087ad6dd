package br.com.saodimas.view.components.panel.obito;

import java.awt.BorderLayout;
import java.awt.Component;
import java.awt.Dimension;
import java.awt.FlowLayout;
import java.awt.GridBagConstraints;
import java.awt.GridBagLayout;
import java.awt.Insets;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.KeyAdapter;
import java.awt.event.KeyEvent;
import java.util.List;

import javax.swing.BorderFactory;
import javax.swing.ImageIcon;
import javax.swing.JButton;
import javax.swing.JComboBox;
import javax.swing.JLabel;
import javax.swing.JPanel;
import javax.swing.JTextField;

import br.com.saodimas.controller.Controller;
import br.com.saodimas.model.beans.CidadeVO;
import br.com.saodimas.model.beans.ObitoVO;
import br.com.saodimas.view.components.document.CustomDocument;
import br.com.saodimas.view.components.panel.BarraNotificacao;
import br.com.saodimas.view.util.ExpReg;

@SuppressWarnings("serial")
public class ConsultaObitoPanel extends JPanel {
	private static final String MENSAGEM_PADRAO = " ";
	
	private BarraNotificacao barNotificacao;
	
	private JLabel lbNumApolice;
	private JLabel lbCidade;
	
	private JTextField textNumApolice;
	private JComboBox cbCidades;
	
	private JButton btCancelar;
	private JButton btEnviar;
	
	private static final Dimension DLABEL = new Dimension(120,22);
	
	
	public ConsultaObitoPanel() {
		initialize();
		configure();
	}

		
	public void focoPadrao(){
		
		this.loadCidades();
	}	
	
	private void loadCidades()
	{
		cbCidades.removeAllItems();
		List<CidadeVO> list = Controller.getInstance().getCidadeAll();
		CidadeVO cidadeTodos = new CidadeVO();
		cidadeTodos.setId(null);
		cidadeTodos.setNome("Todas");
		cbCidades.addItem(cidadeTodos);
		for ( int i = 0 ; i < list.size(); i++) {
			cbCidades.addItem(list.get(i));
		}
		
		
	}

	private void initialize() {
		barNotificacao = new BarraNotificacao(MENSAGEM_PADRAO);
		
		lbNumApolice = new JLabel("Nº Apólice: ", JLabel.RIGHT);
		lbNumApolice.setVisible(true);
		
		lbCidade = new JLabel("Cidade: ", JLabel.RIGHT);
		lbCidade.setPreferredSize(DLABEL);
		lbCidade.setMinimumSize(DLABEL);
		lbCidade.setVisible(true);
		
		cbCidades = new JComboBox();
		cbCidades.setVisible(true);
		
		CustomDocument contrDoc = new CustomDocument(ExpReg.NUMERIC, 20);
		textNumApolice = new JTextField();
		textNumApolice.setDocument(contrDoc);
		textNumApolice.setVisible(true);
		textNumApolice.requestFocus();
		
			
		btCancelar = new JButton("Cancelar", new ImageIcon("imagens/cancel.gif"));
		btCancelar.addActionListener(new EventoBotaoControle());
		btCancelar.setHorizontalAlignment(JButton.LEFT);
		
		btEnviar = new JButton("Enviar", new ImageIcon("imagens/submit.gif"));
		btEnviar.addActionListener(new EventoBotaoControle());
		btEnviar.setHorizontalAlignment(JButton.LEFT);
	}
	
	private void configure() {
		GridBagConstraints c = new GridBagConstraints();
		JPanel infServico = new JPanel(new GridBagLayout());

		c.anchor = GridBagConstraints.FIRST_LINE_END;
		c.fill = GridBagConstraints.HORIZONTAL;
		c.insets = new Insets(1, 1, 2, 1);
		c.weightx = 0;

		c.gridy = 0; infServico.add(lbNumApolice, c);
		c.gridy = 1; infServico.add(lbCidade, c);
						
		c.anchor = GridBagConstraints.FIRST_LINE_START;
		c.fill = GridBagConstraints.HORIZONTAL;
		c.weightx = 1;
		c.weighty = 0;
		c.fill = GridBagConstraints.NONE;
		c.fill = GridBagConstraints.HORIZONTAL;
		c.gridy = 0; infServico.add(textNumApolice, c);
		c.gridy = 1; infServico.add(cbCidades, c);
				
		infServico.setBorder(BorderFactory.createTitledBorder("Parâmetros da consulta"));
		adicionarAtalhosComandos(infServico);
		
		JPanel controle = new JPanel(new FlowLayout(FlowLayout.RIGHT));
		controle.add(btEnviar);
		controle.add(btCancelar);
		controle.setMinimumSize(new Dimension(200, 22));
		adicionarAtalhosComandos(controle);
		
		JPanel panelServico = new JPanel(new BorderLayout());
		panelServico.add(barNotificacao, BorderLayout.NORTH);
		panelServico.add(infServico, BorderLayout.CENTER);
		panelServico.add(controle, BorderLayout.SOUTH);
		adicionarAtalhosComandos(panelServico);
		
		JPanel formPrincipal = new JPanel(new FlowLayout(FlowLayout.LEADING));
		formPrincipal.add(panelServico);
		adicionarAtalhosComandos(formPrincipal);
		
		setLayout(new BorderLayout());
		add(formPrincipal, BorderLayout.CENTER);
		adicionarAtalhosComandos(this);
		
		
	}
	
	private void adicionarAtalhosComandos(JPanel panel){
		for (Component c : panel.getComponents()) {
			c.addKeyListener(new KeyAdapter(){
				@Override
				public void keyPressed(KeyEvent e) {
					if (e.getKeyCode() == KeyEvent.VK_ESCAPE) btCancelar.doClick();
					else if (e.getKeyCode() == KeyEvent.VK_ENTER) btEnviar.doClick();
					else super.keyPressed(e);
				}
			});
		}
	}	
	
	private Component getPainelPrincipal(){
		Component c = getParent();
		while (c != null){
			if (c instanceof ObitoMainPanel) return c;
			c = c.getParent();
		}
		return c;
	}	
	

		
	private class EventoBotaoControle implements ActionListener{
		public void actionPerformed(ActionEvent e) {
			ObitoMainPanel c = (ObitoMainPanel)getPainelPrincipal();
			if (e.getSource() == btCancelar){
				c.getIFrameConsObito().setVisible(false);
			}
			else if (e.getSource() == btEnviar){
				consultaObitos();
			}
		}
	}

	
	
	private void consultaObitos(){
		ObitoMainPanel c = (ObitoMainPanel)getPainelPrincipal();
		List <ObitoVO> obitoList = Controller.getInstance().consultaObitos(textNumApolice.getText(), new String[1]);
		
		if (obitoList.size() > 0){
			c.carregarObitoTable(obitoList);
			c.mostrarMensagem("Consulta efetuada com sucesso! " + (obitoList.size() == 1 ? " Apenas 1 obito encontrado ..." : obitoList.size() + " obitos encontrados ..."), BarraNotificacao.SUCESSO);
			c.getIFrameConsObito().setVisible(false);
		}
		else{
			c.carregarObitoTable(null);
			c.mostrarMensagem("", BarraNotificacao.DEFAULT);
			barNotificacao.mostrarMensagem("Nenhum obito encontrado com esses critérios...", BarraNotificacao.ERRO);
		}
	}
	
	
	
}
